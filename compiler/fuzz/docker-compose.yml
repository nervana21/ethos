services:

  bitcoind:
    image: bitcoin/bitcoin:30.2
    command: bitcoind -regtest -rpcallowip=0.0.0.0/0 -rpcbind=0.0.0.0:18443 -rpcuser=user -rpcpassword=pass -fallbackfee=0.00001 -server -zmqpubrawblock=tcp://0.0.0.0:28332 -zmqpubrawtx=tcp://0.0.0.0:28333
    ports:
      - "18443:18443"
      - "28332:28332"  # ZMQ raw block
      - "28333:28333"  # ZMQ raw tx
    volumes:
      - bitcoind_data:/root/.bitcoin
    mem_limit: 1g
    networks: [ethos]
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=user", "-rpcpassword=pass", "getblockchaininfo"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  fuzz:
    build:
      context: .
      dockerfile: Dockerfile.fuzz
    image: bitcoin-rpc-fuzz:latest
    working_dir: /work/compiler/fuzz
    volumes:
      - ../../:/work
      - corpus_data:${FUZZ_CORPUS_PATH:-/work/outputs/generated/fuzz/${FUZZ_TARGET:-transport}/corpus}
      - crashes_data:${FUZZ_CRASHES_PATH:-/work/outputs/generated/fuzz/${FUZZ_TARGET:-transport}/crashes}
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info
      - BITCOIND_RPC_URL=http://bitcoind:18443
      - BITCOIND_RPC_USER=user
      - BITCOIND_RPC_PASS=pass
      - FUZZ_TARGET=${FUZZ_TARGET:-transport}
      - FUZZ_SEED=${FUZZ_SEED:-42}
      - ARTIFACT_DIR=/corpus_data/crashes
    command: tail -f /dev/null
    networks: [ethos]
    depends_on:
      - bitcoind
    tmpfs:
      - /tmp:rw,size=1g
    mem_limit: 2g

  fuzz-target:
    extends: fuzz
    command: /bin/sh -lc "/usr/local/cargo/bin/cargo fuzz run ${FUZZ_TARGET:-transport}"
    profiles: ["fuzz"]

  regtest-init:
    image: bitcoin/bitcoin:30.2
    command: ["/bin/bash", "-c", "apt-get update && apt-get install -y curl jq && curl -s -u user:pass -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"getblockchaininfo\",\"id\":1}' http://bitcoind:18443 && echo 'Regtest ready'"]
    depends_on:
      - bitcoind
    profiles: ["fuzzamoto"]

  fuzz-runner:
    extends: fuzz
    command: ./target/release/main stdin-run
    profiles: ["fuzzamoto"]
    depends_on:
      regtest-init:
        condition: service_completed_successfully

  fuzzamoto-harness:
    extends: fuzz
    command: cargo run --release --bin main -- stdin-run --verbose
    profiles: ["fuzzamoto"]
    depends_on:
      regtest-init:
        condition: service_completed_successfully

  # Pipeline generation (orthogonal to fuzzing)
  pipeline-generate:
    extends: fuzz
    command: /bin/sh -lc "cd /work && cargo run --bin ethos-compiler -- pipeline"
    profiles: ["pipeline"]
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG=info

networks:
  ethos:
    driver: bridge
  default:
    driver: bridge

volumes:
  corpus_data:
    driver: local
  crashes_data:
    driver: local
  bitcoind_data:
    driver: local
